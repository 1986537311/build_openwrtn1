name: Use release file to build

on:
  repository_dispatch:
    types:
      - Release-Build

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: unbuntu-22.04
    steps:
      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(cat denpends_ubuntu_2004)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          echo "status=success" >> ${GITHUB_OUTPUT}
          
      - name: Package Armvirt as OpenWrt
        if: steps.init.outputs.status == 'success' && !cancelled()
        uses: ffuqiangg/openwrt_packit@master
        env:
          SCRIPT_REPO_URL: https://github.com/ffuqiangg/openwrt_packit
          OPENWRT_ARMVIRT: https://github.com/ffuqiangg/build_openwrt/releases/download/${{ github.event.client_payload.release_tag }}/openwrt-armvirt-64-default-rootfs.tar.gz 
          PACKAGE_SOC: s905d
          KERNEL_REPO_URL: ${{ github.event.client_payload.kernel_repo_url }}
          KERNEL_VERSION_NAME: ${{ github.event.client_payload.kernel_name }}
          KERNEL_AUTO_LATEST: ${{ github.event.client_payload.kernel_auto }}
          GZIP_IMGS: .7z
          SCRIPT_S905D: mk_openwrt_n1.sh
          OPENWRT_VER: ${{ github.event.client_payload.compile_date }}
          SFE_FLOW: 0
          ENABLE_WIFI_K504: 0
          ENABLE_WIFI_K510: 0
          DISTRIB_REVISION: ${{ github.event.client_payload.compile_date }} 

      - name: Upload firmware to release
        uses: ncipollo/release-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          tag: ${{ github.event.client_payload.release_tag }}
          artifacts: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.7z

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3

